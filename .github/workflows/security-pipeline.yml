name: Security Pipeline

permissions:
  contents: read

on:
  push:
  pull_request:
  workflow_dispatch:

jobs:

  # ==========================
  # Build & smoke test job
  # ==========================
  build:
    runs-on: ubuntu-latest

    steps:
      # --------------------------
      # 1. Checkout repository
      # --------------------------
      - name: Checkout repo
        uses: actions/checkout@v4

      # --------------------------
      # 2. Build Docker image
      # --------------------------
      - name: Build Docker image
        run: docker build -t myapp:latest .

      # --------------------------
      # 3. Run container (smoke test)
      # --------------------------
      - name: Run container
        run: docker run --rm myapp:latest


  # ==========================
  # Trivy filesystem scan job
  # ==========================
  trivy_fs:
    needs: build
    runs-on: ubuntu-latest

    steps:
      # --------------------------
      # 1. Checkout repository
      # --------------------------
      - name: Checkout repo
        uses: actions/checkout@v4

      # --------------------------
      # 2. Trivy FS scan (repo scan)
      # --------------------------
      - name: Trivy Filesystem Scan
        uses: aquasecurity/trivy-action@0.20.0
        with:
          scan-type: fs
          severity: CRITICAL,HIGH
          format: table


  # ==========================
  # Trivy image scan job
  # ==========================
  trivy_image:
    needs: build
    runs-on: ubuntu-latest

    steps:
      # --------------------------
      # 1. Checkout repository
      # --------------------------
      - name: Checkout repo
        uses: actions/checkout@v4

      # --------------------------
      # 2. Build Docker image
      # --------------------------
      - name: Build Docker image
        run: docker build -t myapp:latest .

      # --------------------------
      # 3. Trivy image scan
      # --------------------------
      - name: Trivy Image Scan
        uses: aquasecurity/trivy-action@0.20.0
        with:
          image-ref: myapp:latest
          severity: CRITICAL,HIGH
          format: table


  # ==========================
  # Checkov IaC scan job
  # ==========================
  checkov:
    needs: build
    runs-on: ubuntu-latest

    steps:
      # --------------------------
      # 1. Checkout repository
      # --------------------------
      - name: Checkout repo
        uses: actions/checkout@v4

      # --------------------------
      # 2. Checkov IaC scan
      # --------------------------
      - name: Checkov Scan
        uses: bridgecrewio/checkov-action@v12
        with:
          directory: .
          
  dependency_check:
    needs: build
    runs-on: ubuntu-latest

    steps:
      # --------------------------
      # 1. Checkout repository
      # --------------------------
      - name: Checkout repo
        uses: actions/checkout@v4

      # --------------------------
      # 2. Run OWASP Dependency-Check
      # --------------------------
      - name: OWASP Dependency Check
        uses: dependency-check/Dependency-Check_Action@v3.4.0
        with:
          project: "myapp"
          path: "."
          format: "HTML"

