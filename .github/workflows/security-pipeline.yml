name: Security Pipeline

permissions:
  contents: read
  security-events: write
  actions: read

on:
  push:
  pull_request:
  workflow_dispatch:

jobs:
  # ===========================================================
  # BUILD & SMOKE TEST JOB
  # Ensures the application builds and the container runs before
  # any security scans are executed.
  # ===========================================================
  build:
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4

      - name: Build Docker image
        run: docker build -t myapp:latest .

      - name: Run container (smoke test)
        run: docker run --rm myapp:latest

  # ===========================================================
  # TRIVY FILESYSTEM SCAN JOB
  # Scans repository files for secrets, vulnerable dependencies,
  # and misconfigurations. Job waits for build to succeed first.
  # ===========================================================
  trivy_fs:
    needs: build
    runs-on: ubuntu-latest
    outputs:
      status: ${{ steps.set_status.outputs.status }}

    steps:
      - uses: actions/checkout@v4
      # -------------------------------------------------------
      # Blocking scan: fails pipeline on HIGH/CRITICAL only
      # -------------------------------------------------------
      - name: Trivy Filesystem Scan
        id: trivy_fs_block
        continue-on-error: true
        uses: aquasecurity/trivy-action@0.20.0
        with:
          scan-type: fs
          severity: CRITICAL,HIGH
          format: table
          exit-code: 1

    # -------------------------------------------------------
    # Full SARIF scan: includes ALL severities (INFO ‚Üí CRITICAL)
    # Does NOT block pipeline
    # -------------------------------------------------------
      - name: Trivy FS SARIF Report
        continue-on-error: true
        uses: aquasecurity/trivy-action@0.20.0
        with:
          scan-type: fs
          severity: UNKNOWN,LOW,MEDIUM,HIGH,CRITICAL
          format: sarif
          output: trivy-fs.sarif
          exit-code: 0
  
      # -------------------------------------------------------
      # Upload SARIF to GitHub Security (Code Scanning Alerts)
      # -------------------------------------------------------
      - name: Upload Trivy FS SARIF to GitHub Security
        continue-on-error: true
        uses: github/codeql-action/upload-sarif@v3
        with:
          sarif_file: trivy-fs.sarif
          
      # -------------------------------------------------------
      # Set block in case of high or critical vulnerability
      # -------------------------------------------------------
      - name: Set status output
        id: set_status
        run: |
          if [ "${{ steps.trivy_fs_block.outcome }}" = "success" ]; then
            echo "status=ok" >> $GITHUB_OUTPUT
          else
            echo "status=fail" >> $GITHUB_OUTPUT
          fi
          
  # ===========================================================
  # TRIVY IMAGE SCAN JOB
  # Builds and scans the Docker image for vulnerabilities
  # in OS packages and application dependencies.
  # ===========================================================
  trivy_image:
    needs: build
    runs-on: ubuntu-latest
    outputs:
      status: ${{ steps.set_status.outputs.status }}

    steps:
      - uses: actions/checkout@v4

      - name: Build Docker image
        run: docker build -t myapp:latest .
        
      # -------------------------------------------------------
      # Blocking scan: fails pipeline on HIGH/CRITICAL only
      # -------------------------------------------------------
      - name: Trivy Image Scan
        id: trivy_image_block
        continue-on-error: true
        uses: aquasecurity/trivy-action@0.20.0
        with:
          image-ref: myapp:latest
          severity: CRITICAL,HIGH
          format: table
          exit-code: 1

    # -------------------------------------------------------
    # Full SARIF scan: includes ALL severities
    # Does NOT block pipeline
    # -------------------------------------------------------
      - name: Trivy Image SARIF Report
        continue-on-error: true
        uses: aquasecurity/trivy-action@0.20.0
        with:
          image-ref: myapp:latest
          severity: UNKNOWN,LOW,MEDIUM,HIGH,CRITICAL
          format: sarif
          output: trivy-image.sarif
          exit-code: 0
  
      # -------------------------------------------------------
      # Upload SARIF to GitHub Security
      # -------------------------------------------------------
      - name: Upload Trivy Image SARIF to GitHub Security
        continue-on-error: true
        uses: github/codeql-action/upload-sarif@v3
        with:
          sarif_file: trivy-image.sarif 

      # -------------------------------------------------------
      # Set block in case of high or critical vulnerability
      # -------------------------------------------------------
      - name: Set status output
        id: set_status
        run: |
          if [ "${{ steps.trivy_image_block.outcome }}" = "success" ]; then
            echo "status=ok" >> $GITHUB_OUTPUT
          else
            echo "status=fail" >> $GITHUB_OUTPUT
          fi

  # ===========================================================
  # CHECKOV IaC SCAN JOB
  # Analyzes Dockerfile, GitHub workflows, and IaC files for
  # misconfigurations or security policy violations.
  # ===========================================================
  checkov:
    needs: build
    runs-on: ubuntu-latest
    outputs:
      status: ${{ steps.set_status.outputs.status }}

    steps:
      - uses: actions/checkout@v4

      # ----------------------------------------------------------
      # Run Checkov scan across all project files
      # Checkov action generates results.sarif
      # ----------------------------------------------------------
      - name: Checkov Scan
        id: checkov_block
        continue-on-error: true
        uses: bridgecrewio/checkov-action@v12
        with:
          directory: .
          hard_fail_on: HIGH,CRITICAL
          soft_fail_on: MEDIUM,LOW,INFO
          
      # -------------------------------------------------------
      # Upload generated SARIF file to GitHub Security
      # Checkov writes it to results.sarif by default
      # -------------------------------------------------------
      - name: Upload Checkov SARIF to GitHub Security
        continue-on-error: true
        uses: github/codeql-action/upload-sarif@v4
        with:
          sarif_file: results.sarif

      # -------------------------------------------------------
      # Set block in case of high or critical vulnerability
      # -------------------------------------------------------
      - name: Set status output
        id: set_status
        run: |
          if [ "${{ steps.checkov_block.outcome }}" = "success" ]; then
            echo "status=ok" >> $GITHUB_OUTPUT
          else
            echo "status=fail" >> $GITHUB_OUTPUT
          fi
  # ===========================================================
  # DEPENDENCY-CHECK JOB
  # Downloads OWASP Dependency-Check, updates vulnerability data,
  # scans project dependencies, and generates an HTML report.
  # ===========================================================
  
  dependency_check:
    needs: build
    runs-on: ubuntu-latest
    outputs:
      status: ${{ steps.set_status.outputs.status }}
    env:
      HOME: /home/runner

    steps:
      - uses: actions/checkout@v4

      # -------------------------------------------------------
      # Fetch the latest Dependency-Check release automatically
      # -------------------------------------------------------
      - name: Get latest Dependency-Check ZIP URL
        id: dc_asset
        run: |
          url=$(curl -s https://api.github.com/repos/jeremylong/DependencyCheck/releases/latest \
            | jq -r '.assets[] 
              | select(.name | test("^dependency-check-[0-9.]+-release\\.zip$"))
              | .browser_download_url')

          {
            echo "url<<EOF"
            echo "$url"
            echo "EOF"
          } >> $GITHUB_OUTPUT

      # -------------------------------------------------------
      # Download and extract the Dependency-Check tool
      # -------------------------------------------------------
      - name: Download and extract Dependency-Check
        run: |
          url="${{ steps.dc_asset.outputs.url }}"
          echo "Downloading: $url"

          curl -L "$url" -o dependency-check.zip
          unzip dependency-check.zip

          extracted=$(find . -maxdepth 1 -type d -name "dependency-check*" | head -n 1)
          echo "Extracted folder: $extracted"

          if [ "$extracted" != "./dependency-check" ] && [ "$extracted" != "dependency-check" ]; then
            mv "$extracted" dependency-check
          fi

      # -------------------------------------------------------
      # Export the NVD API key for faster vulnerability updates
      # -------------------------------------------------------
      - name: Export NVD API Key for ODC
        run: echo "NVD_API_KEY=${{ secrets.NVD_API_KEY }}" >> $GITHUB_ENV

      # -------------------------------------------------------
      # Run the full Dependency-Check scan on the repository
      # -------------------------------------------------------
      - name: Run Dependency-Check
        id: dc_block
        continue-on-error: true
        run: |
          mkdir -p dependency-check-report
          ./dependency-check/bin/dependency-check.sh \
            --project "myapp" \
            --scan "." \
            --exclude "dependency-check/*" \
            --out "dependency-check-report" \
            --format "HTML" \
            --format "SARIF" \
            --disableOssIndex \
            --nvdApiKey $NVD_API_KEY \
            --failOnCVSS 7.0

            
      # -------------------------------------------------------
      # Upload the generated HTML report as a pipeline artifact
      # -------------------------------------------------------
      - name: Upload Dependency-Check report
        uses: actions/upload-artifact@v4
        with:
          name: dependency-check-report
          path: dependency-check-report

      # -------------------------------------------------------
      # Upload Dependency-Check SARIF to GitHub Security
      # -------------------------------------------------------
      - name: Upload Dependency-Check SARIF to GitHub Security
        uses: github/codeql-action/upload-sarif@v4
        with:
          sarif_file: dependency-check-report/dependency-check-report.sarif

      # -------------------------------------------------------
      # Set block in case of high or critical vulnerability
      # -------------------------------------------------------
      - name: Set status output
        id: set_status
        run: |
          if [ "${{ steps.dc_block.outcome }}" = "success" ]; then
            echo "status=ok" >> $GITHUB_OUTPUT
          else
            echo "status=fail" >> $GITHUB_OUTPUT
          fi
    # ==========================================================================
    # SECURITY GATE JOB
    # Fails if ANY security scan failed in previous jobs (HIGH/CRITICAL found).
    # ==========================================================================
    
  security_gate:
      needs:
        - trivy_fs
        - trivy_image
        - checkov
        - dependency_check
      runs-on: ubuntu-latest
    
      steps:
      - name: Evaluate security results
        run: |
          echo "üîê Checking scan results..."

          declare -A results=(
            ["trivy_fs"]="${{ needs.trivy_fs.outputs.status }}"
            ["trivy_image"]="${{ needs.trivy_image.outputs.status }}"
            ["checkov"]="${{ needs.checkov.outputs.status }}"
            ["dependency_check"]="${{ needs.dependency_check.outputs.status }}"
          )

          failed="false"

          for job in "${!results[@]}"; do
            s="${results[$job]}"
            echo "$job ‚Üí $s"
            if [[ "$s" = "fail" ]]; then
              failed="true"
            fi
          done

          if [[ "$failed" = "true" ]]; then
            echo "‚ùå SECURITY GATE FAILED ‚Äî blocking vulnerabilities found."
            exit 1
          fi

          echo "‚úîÔ∏è SECURITY GATE PASSED ‚Äî all blocking checks clean."
    
  
